# Aladdin DAO F(x) Contracts

### What is Concentrator?

Concentrator is a yield enhancement product by AladdinDAO built for smart farmers who wish to use their Convex LP assets to farm top-tier DeFi tokens (CRV, CVX) at the highest APY possible.  Increase your yields on Convex farms by the CRV staking pool APY.

### How does it work?

Farmers deposit their Convex vault LP tokens in Concentrator.  Yields from those vaults are harvested, swapped to CRV and then staked on behalf of the farmer in the Convex CRV vault where they autocompound.  Users may withdraw any or all of their deposit and yield at any time in CRV or (zap to) CVX!

### Is it an autocompounder?

An autocompounder generally sells all farming rewards for a vault in order to buy more of the deposited token.  The APY is generated by compounding the base rate, but the base rate for the yield is the same as that for the bulk deposit.  Gains are realized continuously rather than at a time chosen by the farmer.

Concentrator can capture rewards from deposits in multiple different Convex vaults and merge them into CRV where they take advantage of the high CRV staking rate on Convex.  Yields auto-compound at this higher rate, denominated in a top-tier DeFi token (CRV) and gains can be realized/claimed in CRV or CVX at a time chosen by the farmer for maximum tax advantage.

### Is it safe?

Concentrator is built by the experienced and security-obsessed AladdinDAO team, and it is audited by SECBIT Labs.

Check out the audit [here](./audit-reports/SECBIT_Concentrator_Report.pdf).

## Development

### install dependency
install yarn

```
yarn install
```

### compile contract

```
yarn hardhat compile
```

### unit test

```
yarn hardhat test
```

### visual studio code
add the following extensions:
* Markdown Preview Mermaid Support (for the diagrams in readme.md)
* vscode-pdf (to see the whitepapers)
* Solidity (nomic foundation one)

## Contract relationships

### Test setup
``` mermaid
---
title: Treasury
---
graph TB

WETH9[WETH9:ERC20]
PriceOracle(FxPriceOracle)
Market[market:address]
anyone[anyone:address]
owner[owner:address]
user[user:address]

FractionalToken(FractionalToken)
LeveragedToken(LeveragedToken)

FractionalToken -. nav .-> anyone
FractionalToken -. 500 .-> user
LeveragedToken -. 500 .-> user

owner -. beta<br>initializePrice()<br>updateStrategy(address)<br>updateSettleWhitelist(address)<br>updatePriceOracle(address) .-> Treasury

Treasury(Treasury)
Treasury --> Market
Market -. mint(amount,user) .-> Treasury
Treasury --> WETH9
Treasury --> LeveragedToken
Treasury --> FractionalToken
Treasury --> PriceOracle
PriceOracle -. price of baseToken .-> Treasury

Treasury -. amount of baseToken .-> user

WETH9 -.-> Treasury


```

### High level 2
``` mermaid
---
title: f(x) contracts and relationships
---
graph TB

  %%ERC20[ERC20]

  FractionalToken(FractionalToken)
  %%FractionalToken -.-> ERC20
  FractionalToken --> Treasury

  LeveragedToken(LeveragedToken)
  %%LeveragedToken -.-> ERC20
  LeveragedToken --> Treasury
  LeveragedToken --> FractionalToken

  Treasury(Treasury)
  %%Treasury -.-> ITreasury
  Treasury --> IMarket
  Treasury --> baseToken
  Treasury --> lpToken
  Treasury --> fxToken

  HarvestableTreasury(HarvestableTreasury)
  HarvestableTreasury -.-> Treasury
  HarvestableTreasury --> platform
  HarvestableTreasury --> RebalancePool

  %%lpToken -.-> ERC20
  %%fxToken -.-> ERC20
  %%baseToken -.-> ERC20

  FXVault --> lpToken
  FXVault --> fxToken
  FXVault --> ITokenWrapper

  RebalancePool -.-> IRebalancePool

  RebalancePool --> Treasury
  RebalancePool --> IMarket
  RebalancePool --> baseToken
  RebalancePool --> ITokenWrapper

  FxTokenBalancerV2Wrapper -.-> ITokenWrapper
  FxTokenBalancerV2Wrapper --> IBalancerVault


  classDef external fill:#fff,stroke:#333,stroke-width:2px
  class ERC20 external


```



### High Level 1

``` mermaid
---
title: f(x) contracts and relationships
config:
    class:
        defaultRenderer: elk // dagre-d3
---
classDiagram

  FractionalToken --* Treasury
  class FractionalToken {
    ERC20
  }

  LeveragedToken --* Treasury
  LeveragedToken --* FractionalToken
  class LeveragedToken {
    ERC20
  }

  FXVault --* lpToken-ERC20
  FXVault --* fxToken-ERC20
  FXVault --* ITokenWrapper

  class Treasury {
    ITreasury
  }
  Treasury --* IMarket
  Treasury --* baseToken-ERC20
  Treasury --* lpToken-ERC20
  Treasury --* fxToken-ERC20

  HarvestableTreasury --|> Treasury
  HarvestableTreasury --* platform
  HarvestableTreasury --* RebalancePool

  class RebalancePool {
    IRebalancePool
  }
  RebalancePool --* Treasury
  RebalancePool --* IMarket
  RebalancePool --* baseToken-ERC20
  RebalancePool --* ITokenWrapper

  FxTokenBalancerV2Wrapper --|> ITokenWrapper
  FxTokenBalancerV2Wrapper --* IBalancerVault


```

### Detail

``` mermaid
---
title: f(x) contracts and relationships
config:
    class:
        defaultRenderer: elk // dagre-d3
---
classDiagram
  class ERC20{
    +name
    +symbol
    +totalSupply
    +balanceOf(address)
    +transfer(recipient, amount)
    +transferFrom(sender, recipient, amount)
    +allowance(owner, spender)
    +approve(spender, amount)
  }

  class FractionalToken{
    +nav
  }
  FractionalToken --* ITreasury:treasury
  FractionalToken --|> ERC20

  class LeveragedToken {
    +nav()
  }
  LeveragedToken --* ITreasury:treasury
  LeveragedToken --* ERC20:fToken
  LeveragedToken --|> ERC20

  class FXVault{
    +fxRatio
    +totalFxToken
    +totalLpToken
    +deposit()
    +redeem()
    #rebalance()
    #updateWrapper()
  }

  class ITokenWrapper{
    +src():address
    +dst():address
    +wrap(srcAmount):dstAmount
    +unwrap(dstAmount):srcAmount
  }

  FXVault --* ERC20:lpToken
  FXVault --* ERC20:fxToken
  FXVault --* ITokenWrapper: wrapper

  class ITreasury {
    +baseToken()
    +fToken()
    +xToken()
    lastPermissionedPrice()
    +totalBaseToken()
    +strategyUnderlying()
    +collateralRatio()
    +convertToWrapped(amount):wrappedAmount
    +convertToUnwrapped(wrappedAmount):amount
    +getCurrentNav():(baseNav,fNav,xNav)
    +maxMintableFToken(newCollateralRatio):(maxBaseAmount, maxFTokenMintable)
    +maxMintableFTokenWithIncentive(newCollateralRatio,incentiveRatio):(maxBaseAmount, maxFTokenMintable)
    +maxMintableXToken(newCollateralRatio):(maxBaseAmount, maxXTokenMintable)
    +maxMintableXTokenWithIncentive(newCollateralRatio,incentiveRatio):(maxBaseAmount, maxXTokenMintable)
    +maxRedeemableFToken(newCollateralRatio):(maxBaseOut,maxFTokenRedeemable)
    +maxRedeemableXToken(uint256 newCollateralRatio):(maxBaseOut,maxXTokenRedeemable)
    +maxLiquidatable(newCollateralRatio,incentiveRatio):(maxBaseOut,maxFTokenLiquidatable)
    +mint(baseAmount,recipient,MintOption):(fTokenOut,xTokenOut)
    +redeem(fTokenAmount,xTokenAmount,owner):baseAmount
    +addBaseToken(baseAmount,incentiveRatio,recipient):xTokenAmpount
    +liquidate(fTokenAmount,incentiveRatio,owner):baseAmount
    +protocolSettle()
    +transferToStrategy(amount)
    +notifyStrategyProfit(amount)
  }

  class Treasury {
    +collateralRatio()
    +getCurrentNav()
    +convertToWrapped(amount):wrappedAmount
    +convertToUnwrapped(wrappedAmount):amount
    #transferToStrategy()
    #notifyStrategyProfit()
    #initialisePrice()
    #updateStrategy()
    #updateBeta()
    #updatePriceOracle()
    #updateRateProvider()
    #updateSettleWhitelist()
    #updateBaseTokenCap()

    +priceOracle
    +beta
    +lastPermissionedPrice
    +baseTokenCap
    +totalBaseToken
    +strategy
    +strategyUnderlying
    +SettleWhitelist
    +rateProvider

  }
  Treasury --|> ITreasury
  Treasury --* IMarket: market
  Treasury --* ERC20: baseToken
  Treasury --* ERC20:lpToken
  Treasury --* ERC20:fxToken

  class HarvestableTreasury{
    +harvestBountyRatio
    +stabilityPoolRatio
    +harvest()
    #updateStabilityPool()
    #updateRewardRatio()
  }
  HarvestableTreasury --|> Treasury
  HarvestableTreasury --* platform
  HarvestableTreasury --* IRebalancePool:stabilityPool

  class IRebalancePool {
    +asset():address
    +totalSupply():amount
    +balanceOf(account):amount
    +unlockedBalanceOf(account):amount
    +unlockingBalanceOf(account):(balance, unlockAt)
    +claimable(account,token):amount
    +deposit(amount,recipient)
    +unlock(amount)
    +withdrawUnlocked(claim?,unwrap?)
    +claim(token,unwrap?)
    +claim(tokens,unwrap?)
    +liquidate(maxAmount,minBaseOut):(liquidated,baseOut)
    +updateAccountSnapshot(account)
    +depositReward(token,amount)
  }
  class RebalancePool {
    +totalUnlocking
    +liquidator:address
    #updateLiquidator(liquidator)
    +liquidatableCollateralRatio
  }
  RebalancePool --|> IRebalancePool
  RebalancePool --* ITreasury: treasury
  RebalancePool --* IMarket: market
  RebalancePool --* ERC20: baseToken
  RebalancePool --* ITokenWrapper: wrapper


  class FxTokenBalancerV2Wrapper {
    +src
    +dst
    +srcIndex
    +poolId
    -weth
  }
  FxTokenBalancerV2Wrapper --|> ITokenWrapper
  FxTokenBalancerV2Wrapper --* IBalancerVault:balancerVault


```

## Deployment

see: [Deployments](https://github.com/AladdinDAO/deployments).